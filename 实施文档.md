# 开源前安全整改实施文档

## 1. 目标与范围
- 彻底清除仓库中的密钥、凭证、数据库、构建产物与敏感文档，确保将来开源版本不再泄露。
- 建立规范的配置模板、忽略规则与自动化检查，避免未来重复问题。
- 对所有接口与账号执行安全加固（限流、鉴权、密钥隔离）。

## 2. 优先级排序
1. **紧急：密钥脱敏 + 环境清理**（24 小时内）
2. **高：代码库脱敏与历史重写**（48 小时内）
3. **中：接口风控与文档模板化**（72 小时内）
4. **持续：自动化扫描、上线前回归**

## 3. 详细实施步骤
### 3.1 密钥与账号
| 项目 | 位置 | 动作 |
| --- | --- | --- |
| OpenAI/ZhiPu API Key | `tarot-ai-generator/config/settings.yaml`、`translation_config.py`、`.env` | 先将现有 key 从代码与示例文件迁出，改为读取环境变量；上线仅保留 `settings.example.yaml`/`translation_config.example.py` 说明如何配置。 |
| Anthropic/OpenAI 自定义脚本 | `set_anthropic_env.ps1`、`set_codex_env.ps1` | 移除内嵌 token，改为提示用户输入或引用本地 `.env`；历史中清除脚本含密钥的版本。 |
| Google Service Account | `deploy/secrets/google-service-account.json`、`my-tarot-app-*.json` | 将现有 JSON 移出仓库，存放到私有 Vault 或 CI Secret，仓库仅保留 `google-service-account.example.json` 示意文件。 |
| JWT Secret & 管理员口令 | `tarot-backend/.env`、`release/env/backend.env` | 将 secret、管理员密码迁出仓库，统一使用 `.env` 注入；文档注明需要自备密钥，无需立即作废线上值。 |
| 邮件 SMTP/安卓 keystore | `.docs/keystore和key的密码.txt`、`tarot-backend/.env` | 将敏感凭证重新转存到加密存储/Secret Manager，仓库保留脱敏说明；确保 keystore 文件及密码不再提交。 |

### 3.2 仓库改造
1. **建立模板**：
   - `tarot-backend/.env.example`、`release/env/backend.env.example`、`tarot-ai-generator/config/settings.example.yaml`、`translation_config.example.py`。
2. **更新 `.gitignore`（根目录 + 子项目）**：新增 `.docs/**`、`deploy/secrets/**`、`my-tarot-app-*.json`、所有 `.env*`、`release/**`、`debug/**`、`*.apk`、`*.aab`、`*.zip`、`tarot-backend/backend_tarot.db`、`tarot-backend/static/app-releases/**`、`tarot-ai-generator/data/**`、`tarot-ai-generator/output/**`、`tarot-ai-generator/venv/**`、`deploy/nginx/dhparam.pem`、`deploy/certbot/**` 等。
3. **清理文件**：彻底删除实际 `.env`、数据库、APK、zip、截图等文件；用占位说明替换。
4. **重写历史**：
   - 使用 `git filter-repo --invert-paths` 或 `BFG Repo-Cleaner` 移除敏感文件。
   - 强制推送至新的开源仓库，提示协作者重新克隆。

### 3.3 接口加固
- `/auth/anon`、`/users/register`：增加设备签名/一次性 installation_id、IP/设备指纹限流。
- `/api/v1/payments/redeem*`：要求 Bearer Token、对 code 查询/兑换加限流和 CAPTCHA，使用每设备每日配额。
- 管理后台：
  - 引入密码哈希 + 双重认证/OTP；
  - 登录接口 (`tarot-backend/app/api/admin.py`) 加入速率限制、登录失败锁定策略；
  - JWT secret 改为动态注入，支持立即吊销。
- CORS：生产配置只允许移动端域名、管理后台域名；禁用 `allow_credentials` 与 `*` 的组合。
- 静态发布：APP release 移出 `/static/app-releases`，改走对象存储或 CI 工具，公开仓库不再包含生产 APK。

### 3.4 自动化保障
- CI 集成 `gitleaks`/`trufflehog`，在 PR 阶段阻断含 `sk-`、`-----BEGIN PRIVATE KEY-----`、`.db` 的提交。
- 在提交钩子中加入 `pre-commit`（检查 `.env`、`*.db` 等规则）。
- 每次 release 前运行安全脚本：
  1. `gitleaks detect`
  2. `npm/yarn audit` + `pip-audit`
  3. 后端/前端单元测试 & lint

### 3.5 文档与培训
- 在 `CLAUDE.md` / `README.md` 中新增“安全发布”章节，说明如何配置 `.env`、如何运行 secret 扫描。
- 对团队进行一次 30 分钟分享，涵盖密钥管理、历史清理、CI 检查流程。

## 4. 验证清单
1. 仓库无 `.env`、`.db`、`.apk`、截图、zip、cred JSON。
2. `git log --stat` 检查近期 commit，不再出现敏感文件。
3. `gitleaks detect`、`rg 'sk-' -n` 返回空。
4. 新版后端启动需从 `.env` 读取 secret，缺失时启动失败。
5. 管理后台登录失败 5 次后锁定；匿名接口连续请求被限速。
6. Release 包由 CI 生成并存储在外部制品库，不再通过 git 分发。

## 5. 交付物
- 脱敏后的仓库 + `.gitignore` 更新
- `.env.example`、`settings.example.yaml` 等模板文件
- 限流/鉴权补丁 PR（前后端各一）
- CI 密钥扫描配置 (`.github/workflows/security.yml` 或等效)

## 6. 时间表
| 时间 | 任务 |
| --- | --- |
| T+0 ~ T+1 天 | 完成密钥脱敏（迁出仓库）、删除敏感文件、提交 `.gitignore` 与模板文件 |
| T+1 ~ T+2 天 | 完成 git 历史清理、搭建 secret 扫描 CI |
| T+2 ~ T+3 天 | 推出接口限流/鉴权补丁，更新文档与团队培训 |
| T+3 天以后 | 持续安全测试、准备公开发布 |
