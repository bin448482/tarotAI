# APIè·¯ç”±è®¾è®¡ (app/api/CLAUDE.md)

## ğŸ”— APIæ¶æ„æ¦‚è¿°

### APIç»„ç»‡ç»“æ„
```
app/api/
â”œâ”€â”€ __init__.py          # è·¯ç”±æ³¨å†Œ
â”œâ”€â”€ auth.py              # åŒ¿åè®¤è¯ (âœ… å·²å®ç°)
â”œâ”€â”€ readings.py          # è§£è¯»ç›¸å…³API (âœ… å·²å®ç°)
â”œâ”€â”€ admin.py             # ç®¡ç†å‘˜API (âœ… å·²å®ç°)
â”œâ”€â”€ payments.py          # æ”¯ä»˜ç›¸å…³API (âœ… å·²é‡æ„)
â”œâ”€â”€ users.py             # ç”¨æˆ·APIè·¯ç”± (âœ… å·²å®ç°)
â””â”€â”€ sync.py              # ç¦»çº¿åŒæ­¥API (ğŸ”„ å¾…å®ç°)
```

### APIç‰ˆæœ¬ç®¡ç†
- **æ ¸å¿ƒAPI**: `/` æ ¹è·¯å¾„ (è§£è¯»åŠŸèƒ½)
- **æ”¯ä»˜API**: `/api/v1/payments/` (å…‘æ¢ç ã€Google Play)
- **ç®¡ç†è®¤è¯API**: `/api/v1/admin-api/` (ç®¡ç†å‘˜ç™»å½•ã€è®¤è¯)
- **ç®¡ç†åŠŸèƒ½API**: `/api/v1/admin/` (ç”¨æˆ·ç®¡ç†ã€å…‘æ¢ç ç®¡ç†)
- **ç®¡ç†Portal**: `/admin/` (Webç•Œé¢)
- **ç”¨æˆ·API**: `/api/v1/me/` (ç”¨æˆ·ä½™é¢ã€äº¤æ˜“å†å²)

## ğŸ“‹ æ ¸å¿ƒAPIæ¥å£ (âœ… å·²å®ç°)

### è®¤è¯ç›¸å…³ (`auth.py`)
**å®ç°ä½ç½®**: `app/api/auth.py`

- **POST /api/v1/users/register**: ç”ŸæˆåŒ¿åç”¨æˆ·IDå’ŒJWT token
- **POST /api/v1/auth/register**: ç”¨æˆ·é‚®ç®±æ³¨å†Œ
- **POST /api/v1/auth/email/verify**: é‚®ç®±éªŒè¯
- **POST /api/v1/auth/email/resend**: é‡å‘éªŒè¯é‚®ä»¶
- **POST /api/v1/auth/email/reset-password**: å¯†ç é‡ç½®

### è§£è¯»ç›¸å…³ (`readings.py`)
**å®ç°ä½ç½®**: `app/api/readings.py`

- **POST /readings/analyze**: åˆ†æç”¨æˆ·æè¿°ï¼Œè¿”å›æ¨èç»´åº¦ï¼ˆâœ… å·²é›†æˆç§¯åˆ†ç³»ç»Ÿï¼‰
- **POST /readings/generate**: åŸºäºé€‰å®šç»´åº¦ç”Ÿæˆå¤šç»´åº¦è§£è¯»ï¼ˆâœ… å·²é›†æˆç§¯åˆ†ç³»ç»Ÿï¼‰
- **GET /cards**: è·å–æ‰€æœ‰å¡ç‰Œä¿¡æ¯
- **GET /dimensions**: è·å–æ‰€æœ‰è§£è¯»ç»´åº¦
- **GET /spreads**: è·å–ç‰Œé˜µé…ç½®

#### ç§¯åˆ†ç³»ç»Ÿé›†æˆç‰¹æ€§ï¼ˆ2024å¹´æ›´æ–°ï¼‰
**å½±å“æ¥å£**: `/readings/analyze` å’Œ `/readings/generate`

**è®¤è¯è¦æ±‚å˜æ›´**:
- **æ—§ç‰ˆæœ¬**: å¯é€‰è®¤è¯ï¼ˆ`get_current_user_id_optional`ï¼‰
- **æ–°ç‰ˆæœ¬**: å¿…éœ€è®¤è¯ï¼ˆ`get_current_user_id`ï¼‰

**æ–°å¢é”™è¯¯çŠ¶æ€ç **:
- **402 Payment Required**: ç”¨æˆ·ç§¯åˆ†ä¸è¶³ï¼ˆ<1ç§¯åˆ†ï¼‰
- **404 Not Found**: ç”¨æˆ·ä¸å­˜åœ¨

**ç§¯åˆ†æ‰£è´¹æµç¨‹**:
1. **äº‹å‰éªŒè¯**: æ£€æŸ¥ç”¨æˆ·ç§¯åˆ†ä½™é¢ â‰¥ 1
2. **LLMè°ƒç”¨**: æ‰§è¡ŒåŸæœ‰ä¸šåŠ¡é€»è¾‘
3. **äº‹åæ‰£è´¹**: LLMæˆåŠŸåæ‰£é™¤1ç§¯åˆ†
4. **å¤±è´¥ä¿æŠ¤**: LLMå¤±è´¥æ—¶ä¸æ‰£è´¹
5. **å®¡è®¡è®°å½•**: è®°å½•äº¤æ˜“åˆ° `CreditTransaction` è¡¨

### æ”¯ä»˜ç›¸å…³ (`payments.py` - å·²é‡æ„)
**å®ç°ä½ç½®**: `app/api/payments.py`

**é‡æ„è¯´æ˜**ï¼š
- **è·¯ç”±å‰ç¼€**: `/api/v1/payments`
- **èŒè´£èŒƒå›´**: å‰ç«¯æ”¯ä»˜åŠŸèƒ½ï¼ˆå…‘æ¢ç å…‘æ¢ã€Google PlayéªŒè¯ï¼‰
- **è®¤è¯æ–¹å¼**: Bearer Tokenï¼ˆé¢å‘å‰ç«¯åº”ç”¨ï¼‰
- **å·²åˆ é™¤**: æ‰€æœ‰ç®¡ç†å‘˜è·¯ç”±ï¼Œç»Ÿä¸€è¿ç§»è‡³ `admin.py`

#### æ ¸å¿ƒåŠŸèƒ½
- **POST /api/v1/payments/redeem**: å…‘æ¢ç éªŒè¯å…‘æ¢
- **POST /api/v1/payments/redeem/info**: è·å–å…‘æ¢ç ä¿¡æ¯ï¼ˆä¸ä½¿ç”¨ï¼‰
- **POST /api/v1/payments/google/verify**: Google Playè´­ä¹°éªŒè¯
- **POST /api/v1/payments/google/consume**: æ ‡è®°Google Playè´­ä¹°å·²æ¶ˆè´¹
- **POST /api/v1/payments/webhooks/google/play**: Google Play webhooks

## ğŸ” ç®¡ç†å‘˜APIæ¥å£ (âœ… å·²å®ç°)

### ç®¡ç†å‘˜è®¤è¯ (`admin.py`)
**å®ç°ä½ç½®**: `app/api/admin.py:100-182`
**è®¤è¯æ–¹å¼**: JWT Bearer Tokenï¼ˆå·²ç»Ÿä¸€ç§»é™¤Cookieè®¤è¯ï¼‰

- **POST /api/v1/admin-api/login**: ç®¡ç†å‘˜ç™»å½•è®¤è¯
- **GET /api/v1/admin-api/profile**: è·å–å½“å‰ç®¡ç†å‘˜ä¿¡æ¯
- **POST /api/v1/admin-api/refresh**: åˆ·æ–°JWT token

### ç”¨æˆ·ç®¡ç† (`admin.py`)
**å®ç°ä½ç½®**: `app/api/admin.py:227-583`
**è®¤è¯æ–¹å¼**: JWT Bearer Tokenï¼ˆé€šè¿‡ `Depends(get_current_admin)`ï¼‰

- **GET /api/v1/admin/users**: ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢ï¼ˆåˆ†é¡µã€ç­›é€‰ï¼‰
- **GET /api/v1/admin/users/{id}**: ç”¨æˆ·è¯¦æƒ…å’Œäº¤æ˜“è®°å½•
- **POST /api/v1/admin/users/adjust-credits**: ç®¡ç†å‘˜è°ƒæ•´ç”¨æˆ·ç§¯åˆ†
- **GET /api/v1/admin/users/export**: ç”¨æˆ·æ•°æ®CSVå¯¼å‡º
- **DELETE /api/v1/admin/users/{id}**: åˆ é™¤ç”¨æˆ·åŠç›¸å…³æ•°æ®

### å…‘æ¢ç ç®¡ç† (`admin.py`)
**å®ç°ä½ç½®**: `app/api/admin.py:649-1024`
**è®¤è¯æ–¹å¼**: JWT Bearer Tokenï¼ˆé€šè¿‡ `Depends(get_current_admin)`ï¼‰

- **GET /api/v1/admin/redeem-codes**: å…‘æ¢ç åˆ—è¡¨æŸ¥è¯¢
- **POST /api/v1/admin/redeem-codes/generate**: æ‰¹é‡ç”Ÿæˆå…‘æ¢ç 
- **PUT /api/v1/admin/redeem-codes/{id}**: æ›´æ–°å…‘æ¢ç çŠ¶æ€
- **GET /api/v1/admin/redeem-codes/export/csv**: å…‘æ¢ç CSVå¯¼å‡º
- **GET /api/v1/admin/redeem-codes/stats**: ç»Ÿè®¡ä¿¡æ¯
- **GET /api/v1/admin/redeem-codes/batches**: è·å–æ‰¹æ¬¡åˆ—è¡¨

## ğŸ¨ å‰ç«¯æ¨¡æ¿å’ŒWebè·¯ç”± (âœ… å·²å®ç°)

### ç®¡ç†Portal (`app/admin/web_routes.py`)
- **GET /admin/login**: ç™»å½•é¡µé¢
- **POST /admin/login**: ç™»å½•å¤„ç†
- **GET /admin/dashboard**: ä»ªè¡¨æ¿
- **GET /admin/users**: ç”¨æˆ·ç®¡ç†é¡µé¢
- **GET /admin/redeem-codes**: å…‘æ¢ç ç®¡ç†é¡µé¢

### åŠŸèƒ½ç‰¹æ€§
1. **ç”¨æˆ·ç®¡ç†**: åˆ†é¡µåˆ—è¡¨ã€è¯¦æƒ…æŸ¥çœ‹ã€ç§¯åˆ†è°ƒæ•´ã€æ•°æ®å¯¼å‡º
2. **å…‘æ¢ç ç®¡ç†**: æ‰¹é‡ç”Ÿæˆã€çŠ¶æ€ç®¡ç†ã€ä½¿ç”¨ç»Ÿè®¡
3. **å“åº”å¼è®¾è®¡**: Bootstrap 5æ¡†æ¶ï¼Œç§»åŠ¨ç«¯é€‚é…
4. **å®æ—¶æ›´æ–°**: AjaxåŠ è½½ï¼Œæ— éœ€åˆ·æ–°é¡µé¢

## ğŸ”„ å¾…å®ç°åŠŸèƒ½

### ç”¨æˆ·API (`users.py` - å¾…å®ç°)
- **GET /api/v1/me/balance**: æŸ¥è¯¢ç”¨æˆ·ä½™é¢
- **GET /api/v1/me/transactions**: æ¶ˆè´¹å†å²æŸ¥è¯¢
- **POST /api/v1/consume**: LLMè°ƒç”¨å‰æ‰£ç‚¹

### ç¦»çº¿åŒæ­¥API (`sync.py` - å¾…å®ç°)
- **GET /sync/initial**: åˆå§‹å…¨é‡åŒæ­¥
- **GET /sync/delta**: å¢é‡æ•°æ®æ›´æ–°

## ğŸ”§ æŠ€æœ¯å®ç°

### è®¤è¯æœºåˆ¶
- **åŒ¿åç”¨æˆ·**: JWT tokenï¼Œæ— éœ€æ³¨å†Œ
- **ç®¡ç†å‘˜**: JWT Bearer tokenè®¤è¯ï¼ˆå·²ç»Ÿä¸€ï¼Œç§»é™¤Cookieè®¤è¯ï¼‰
- **é‚®ç®±ç”¨æˆ·**: å¯é€‰æ³¨å†Œï¼Œå¢å¼ºç”¨æˆ·ä½“éªŒ

### æ•°æ®å¤„ç†
- **åˆ†é¡µæŸ¥è¯¢**: é¿å…å¤§é‡æ•°æ®åŠ è½½
- **å…³è”æŸ¥è¯¢**: ä½¿ç”¨ `joinedload` ä¼˜åŒ–N+1é—®é¢˜
- **ä¹è§‚é”**: ä¿è¯ç§¯åˆ†æ“ä½œæ•°æ®ä¸€è‡´æ€§
- **æµå¼å“åº”**: å¤§æ–‡ä»¶å¯¼å‡ºå†…å­˜ä¼˜åŒ–

### é”™è¯¯å¤„ç†
- **å…¨å±€å¼‚å¸¸**: ç»Ÿä¸€é”™è¯¯æ ¼å¼å’Œæ—¥å¿—
- **ç”¨æˆ·å‹å¥½**: å‰ç«¯å±•ç¤ºæ¸…æ™°é”™è¯¯ä¿¡æ¯
- **æ•°æ®éªŒè¯**: Pydanticæ¨¡å‹ä¸¥æ ¼éªŒè¯

## ğŸš€ å·²è§£å†³çš„æŠ€æœ¯é—®é¢˜

### ç§¯åˆ†ç³»ç»Ÿé›†æˆï¼ˆ2024å¹´9æœˆæ›´æ–°ï¼‰
- **éœ€æ±‚**: å¯¹LLMè°ƒç”¨æ¥å£æ·»åŠ ç§¯åˆ†æ£€æŸ¥å’Œè‡ªåŠ¨æ‰£è´¹åŠŸèƒ½
- **å®ç°**: ä¿®æ”¹ `/readings/analyze` å’Œ `/readings/generate` æ¥å£
- **æŠ€æœ¯æ–¹æ¡ˆ**:
  - äº‹å‰ç§¯åˆ†éªŒè¯ + äº‹ååŸå­æ€§æ‰£è´¹
  - ä½¿ç”¨ `UserService.update_user_balance()` ä¹è§‚é”æœºåˆ¶
  - LLMè°ƒç”¨å¤±è´¥æ—¶ä¸æ‰£è´¹çš„å¤±è´¥ä¿æŠ¤æœºåˆ¶
- **å‘åå…¼å®¹**: æ¥å£ä¿æŒä¸å˜ï¼Œåªå¢åŠ è®¤è¯è¦æ±‚å’Œé”™è¯¯ç 

### ç»Ÿä¸€JWTè®¤è¯
- **é—®é¢˜**: ç®¡ç†å‘˜APIæ··åˆä½¿ç”¨Cookieå’ŒBearer tokenè®¤è¯
- **è§£å†³**: ç»Ÿä¸€æ‰€æœ‰APIä½¿ç”¨JWT Bearer tokenè®¤è¯
- **å˜æ›´**: ç§»é™¤ `get_current_admin_from_cookie` å‡½æ•°ï¼Œç»Ÿä¸€ä½¿ç”¨ `get_current_admin`

### è·¯ç”±å†²çªé—®é¢˜
- **é—®é¢˜**: `payments.py` å’Œ `admin.py` å­˜åœ¨é‡å¤è·¯ç”±
- **è§£å†³**: é‡æ„æ¨¡å—èŒè´£ï¼Œåˆ é™¤é‡å¤åŠŸèƒ½
- **å‚è€ƒ**: `tarot-backend/CLAUDE.md` è·¯ç”±å†²çªè§£å†³æ–¹æ¡ˆ

### é‚®ä»¶éªŒè¯404é”™è¯¯
- **é—®é¢˜**: é‚®ä»¶éªŒè¯é“¾æ¥è·¯å¾„é”™è¯¯
- **è§£å†³**: ä¿®æ­£URLç”Ÿæˆé€»è¾‘ï¼Œç¡®ä¿è·¯å¾„åŒ¹é…
- **å‚è€ƒ**: `app/services/email_service.py:31-32`

### ç”¨æˆ·åˆ é™¤çº¦æŸé”™è¯¯
- **é—®é¢˜**: å¤–é”®çº¦æŸå¯¼è‡´åˆ é™¤å¤±è´¥
- **è§£å†³**: æŒ‰æ­£ç¡®é¡ºåºåˆ é™¤å…³è”æ•°æ®
- **å‚è€ƒ**: `app/api/admin.py:546-563`

## ğŸ›¡ï¸ å®‰å…¨è€ƒè™‘

### APIå®‰å…¨
- HTTPSå¼ºåˆ¶ä¼ è¾“
- JWT tokenè¿‡æœŸæ§åˆ¶
- SQLæ³¨å…¥é˜²æŠ¤ï¼ˆSQLAlchemy ORMï¼‰
- è¯·æ±‚å‚æ•°éªŒè¯å’Œè¿‡æ»¤

### æ”¯ä»˜å®‰å…¨
- Google Playå‡­è¯ç­¾åéªŒè¯
- åŸå­æ€§æ”¯ä»˜çŠ¶æ€æ›´æ–°
- å¹‚ç­‰æ€§é˜²é‡å¤è®¢å•
- æ•æ„Ÿä¿¡æ¯ç¯å¢ƒå˜é‡ç®¡ç†

### å…‘æ¢ç å®‰å…¨
- é˜²çˆ†ç ´è¿ç»­å¤±è´¥é”å®š
- 16ä½æ··åˆå­—ç¬¦é˜²é‡å¤
- æ‰¹æ¬¡ç®¡ç†å’Œè¿‡æœŸæ§åˆ¶

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜ç­–ç•¥ï¼ˆè®¡åˆ’å®ç°ï¼‰
- Redisç¼“å­˜ç”¨æˆ·ä½™é¢æŸ¥è¯¢
- é™æ€æ•°æ®ç¼“å­˜ï¼ˆcards, dimensionsï¼‰
- LLMè§£è¯»ç»“æœç¼“å­˜

### é™æµæ§åˆ¶ï¼ˆè®¡åˆ’å®ç°ï¼‰
- æ”¯ä»˜API: æ¯ç”¨æˆ·æ¯å°æ—¶10æ¬¡
- è§£è¯»API: æ¯ç”¨æˆ·æ¯åˆ†é’Ÿ5æ¬¡
- ç®¡ç†API: åŸºäºIPé™åˆ¶

---

*APIæ¶æ„å·²åŸºæœ¬å®Œæˆï¼Œæ ¸å¿ƒåŠŸèƒ½å‡å·²å®ç°å¹¶é€šè¿‡æµ‹è¯•ã€‚å¾…å®ç°åŠŸèƒ½ä¸»è¦ä¸ºç”¨æˆ·APIå’Œç¦»çº¿åŒæ­¥ã€‚*